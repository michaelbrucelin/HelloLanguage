# 千变万化的股票交易问题

动态规划的两大要素：

> 1. 问题的初始状态
> 2. 问题的状态转移方程

## 1. 只允许买卖两次

### 问题

给定一个price数组，它存储着每天的股票价格，第n个元素代表第n天的价格。
如果最多允许2次买卖，那么股票的最大收益是多少？不允许连续买入。

### 分析

既然限制了股票最多只能买卖两次，那么股票的交易可以分为下面5个阶段：

> 没有买卖
> 第1次买入
> 第1次卖出
> 第2次买入
> 第2次卖出

我们把股票的交易阶段设为变量m（用0-4表示），把天数范围设为变量n。那么求解的最大收益可以使用下面的函数表示：

> 最大收益 = F(m, n) ($0 <= m <= 4, n >= 1$)

下面开始确认动态规划的两大要素：

**1. 初始状态：**

假定交易的天数只有1天，那么这1天的交易时间对应5个交易状态的初始状态为：

> F(0, 1) = 0          没有买卖，显然最大收益为0
> F(1, 1) = -price[0]  第1次买入，显然... ...
> F(2, 1) = 0          第1次卖出，显然... ...
> F(3, 1) = -price[0]  第2次买入，显然... ...
> F(4, 1) = 0          第2次卖出，显然... ...

**2. 状态转移方程：**

假定已经交易了n-1天，那么第n天交易后的最大收益为：

> 1. 如果第n-1天后的交易状态为0，即没有交易，如果第n天仍然没有买卖，则 F(0, n) = F(0, n-1) = 0
> 2. 如果第n-1天后的交易状态为0，即没有交易，如果第n天完成第1笔买入，则 F(1, n) = F(0, n-1) - price[n-1] = -price[n-1]
> 3. 如果第n-1天后的交易状态为1，即完成了第1次买入，如果第n天仍然没有买卖，则 F(1, n) = F(1, n-1)
> 4. 如果第n-1天后的交易状态为1，即完成了第1次买入，如果第n天完成第1笔卖出，则 F(2, n) = F(1, n-1) + price[n-1]
> 5. 如果第n-1天后的交易状态为2，即完成了第1次卖出，如果第n天仍然没有买卖，则 F(2, n) = F(2, n-1)
> 6. 如果第n-1天后的交易状态为2，即完成了第1次卖出，如果第n天完成第2笔买入，则 F(3, n) = F(2, n-1) - price[n-1]
> 7. 如果第n-1天后的交易状态为3，即完成了第2次买入，如果第n天仍然没有买卖，则 F(3, n) = F(3, n-1)
> 8. 如果第n-1天后的交易状态为3，即完成了第2次买入，如果第n天完成第2笔卖出，则 F(4, n) = F(3, n-1) + price[n-1]
> 9. 如果第n-1天后的交易状态为4，即完成了第2次卖出，那么第n天一定不会发生买卖，则 F(4, n) = F(4, n-1)

将上面的结论合并

> F(0, n) = 0
> F(1, n) = MAX(F(0, n-1) - price[n-1], F(1, n-1))
> F(2, n) = MAX(F(1, n-1) + price[n-1], F(2, n-1))
> F(3, n) = MAX(F(2, n-1) - price[n-1], F(3, n-1))
> F(4, n) = MAX(F(3, n-1) + price[n-1], F(4, n-1))

所以

> $F(m, n)=
> \begin{cases}
> 0 & (m = 0, n \geq 1) \\
> MAX(F(m-1, n-1) - price[n-1], F(m, n-1)) & (1 \leq m \leq 4, n \geq 1, m为奇数) \\
> MAX(F(m-1, n-1) + price[n-1], F(m, n-1)) & (1 \leq m \leq 4, n \geq 1, m为偶数)
> \end{cases}$

既然问题的初始状态和状态转移方程都确定了，接下来就是自底向上的求解过程了。
为了更直观地演示，我们画一张关于天数、阶段与最大收益的表格：

| n`[price]` | 没有买卖<br/>`m=0` | 第1次买入<br/>`m=1` | 第1次卖出<br/>`m=2` | 第2次买入<br/>`m=3` | 第2次卖出<br/>`m=4` |
| -- | -- | -- | -- | -- | -- |
| **第1天**`[1]` | 0 | -1 | 0 | -1 |  0 |
| **第2天**`[2]` | 0 | -1 | 1 | -1 |  1 |
| **第3天**`[4]` | 0 | -1 | 3 | -1 |  3 |
| **第4天**`[8]` | 0 | -1 | 7 | -1 |  7 |
| **第5天**`[3]` | 0 | -1 | 7 |  4 |  7 |
| **第6天**`[9]` | 0 | -1 | 8 |  4 | 13 |
| **第7天**`[6]` | 0 | -1 | 8 |  4 | 13 |
| **第8天**`[7]` | 0 | -1 | 8 |  4 | 13 |
